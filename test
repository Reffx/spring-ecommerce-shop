SELECT
    sub.isin,
    sub.status,
    MAX(sub.severityScore),
    SUM(sub.diffQuantity),
    SUM(sub.diffGrossAmountOriginalCurrency),
    SUM(sub.diffTaxAmountOriginalCurrency),
    SUM(sub.diffGrossAmountUsd),
    SUM(sub.diffTaxAmountUsd),
    CASE WHEN COUNT(DISTINCT sub.originalCurrencyIso) = 1
         THEN MAX(sub.originalCurrencyIso)
         ELSE 'various'
    END AS originalCurrencyIso,
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'DATASTORE_PAYMENT' THEN sub.quantity ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'DATASTORE_PAYMENT' THEN sub.grossAmountOriginalCurrency ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'DATASTORE_PAYMENT' THEN sub.grossAmountUsd ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'DATASTORE_PAYMENT' THEN sub.taxAmountOriginalCurrency ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'DATASTORE_PAYMENT' THEN sub.taxAmountUsd ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'CUSTODIAN_PAYMENT' THEN sub.quantity ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'CUSTODIAN_PAYMENT' THEN sub.grossAmountOriginalCurrency ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'CUSTODIAN_PAYMENT' THEN sub.grossAmountUsd ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'CUSTODIAN_PAYMENT' THEN sub.taxAmountOriginalCurrency ELSE 0 END), 0) AS BigDecimal),
    CAST(COALESCE(SUM(CASE WHEN sub.bucketType = 'CUSTODIAN_PAYMENT' THEN sub.taxAmountUsd ELSE 0 END), 0) AS BigDecimal)
FROM (
    SELECT
        m.isin,
        FIRST_VALUE(m.status) OVER (
            PARTITION BY m.isin
            ORDER BY m.severityScore DESC
        ) AS status,
        m.severityScore,
        m.diffQuantity,
        m.diffGrossAmountOriginalCurrency,
        m.diffTaxAmountOriginalCurrency,
        m.diffGrossAmountUsd,
        m.diffTaxAmountUsd,
        m.originalCurrencyIso,
        b.bucketType,
        b.quantity,
        b.grossAmountOriginalCurrency,
        b.grossAmountUsd,
        b.taxAmountOriginalCurrency,
        b.taxAmountUsd
    FROM MatchEntity m
    LEFT JOIN BucketEntity b
        ON b.techId = m.techId
) sub
GROUP BY sub.isin, sub.status
